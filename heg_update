#!/bin/sh

RELEASE_URL="https://raw.githubusercontent.com/auhems/heg_release/main/README.md"
TMP_RELEASE="/tmp/README.md"

### Version comparison function ###
# assuming versions are all 3 numbers like 1.2.3
version_greater() {
    [ "$1" = "$2" ] && return 1

    # Compare major.minor.patch numerically
    IFS=. read -r a1 a2 a3 <<EOF
$1
EOF
    IFS=. read -r b1 b2 b3 <<EOF
$2
EOF

    [ "$a1" -gt "$b1" ] && return 0
    [ "$a1" -lt "$b1" ] && return 1
    [ "$a2" -gt "$b2" ] && return 0
    [ "$a2" -lt "$b2" ] && return 1
    [ "$a3" -gt "$b3" ] && return 0
    return 1
}

### Detect OS ###
OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
case "$OS" in
    linux) HOST_OS="linux" ;;
    darwin) HOST_OS="darwin" ;;
    *) echo "Unsupported OS: $OS"; exit 1 ;;
esac

### Detect ARCH ###
ARCH="$(uname -m)"
case "$ARCH" in
    x86_64) HOST_ARCH="amd64" ;;
    aarch64|arm64) HOST_ARCH="arm64" ;;
    armv7l|armv6l) HOST_ARCH="arm32" ;;
    *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
esac

echo "Detected system: $HOST_OS / $HOST_ARCH"

# If using wget, probably need --inet4-only option to avoid the IPv6 connection
# wget --inet4-only https://raw.githubusercontent.com/auhems/heg_release/main/README.md
echo "Downloading release file..."
curl -fsSL "$RELEASE_URL" -o "$TMP_RELEASE" || {
    echo "ERROR: Cannot download release file."
    exit 1
}

### Extract matching row ###
LINE=$(grep "^|Latest|$HOST_OS|$HOST_ARCH|" "$TMP_RELEASE")
if [ -z "$LINE" ]; then
    echo "ERROR: No matching release found."
    rm -f $TMP_RELEASE
    exit 1
fi

# Example row:
# |Latest|linux|arm64|1.0.0|`https://.../heg_linux_arm64_1.0.0.deb`|

#REMOTE_VERSION="1.0.1"
REMOTE_VERSION=$(echo "$LINE" | cut -d '|' -f 5)
REMOTE_URL=$(echo "$LINE" | cut -d '|' -f 6 | cut -d '`' -f 2)

### Get local version ###
LOCAL_VERSION=$(heg --version | cut -d ' ' -f 3)
if [ -z "$LOCAL_VERSION" ]; then
    echo "Local version not found, treating as 0.0.0"
    LOCAL_VERSION="0.0.0"
fi

echo "Local version : $LOCAL_VERSION"
echo "Remote version: $REMOTE_VERSION"
echo "Remote URL:     $REMOTE_URL"

### Compare versions ###
if version_greater "$REMOTE_VERSION" "$LOCAL_VERSION"; then
    echo "New version available! Downloading..."
    TMP_DEB="/tmp/heg_latest.deb"

    curl -fSL "$REMOTE_URL" -o "$TMP_DEB" || {
        echo "ERROR: Download failed."
        exit 1
    }

    echo "Installing update..."
    dpkg -i "$TMP_DEB"
    echo "Update installed successfully."
    rm -f $TMP_DEB
else
    echo "Already up to date."
fi
rm -f $TMP_RELEASE
